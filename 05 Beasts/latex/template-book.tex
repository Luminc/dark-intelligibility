\documentclass[10pt,a4paper,oneside]{book}

% Packages
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[tracking=true]{microtype}
\usepackage[paperwidth=14.8cm, paperheight=21cm, left=2cm, right=2cm, top=2cm, bottom=2.5cm]{geometry}
\usepackage{setspace}
\usepackage{enumitem}
\usepackage{titlesec}
\usepackage{fancyhdr}
\usepackage{lastpage}
\usepackage{hyperref}
\usepackage{xcolor}
\usepackage{csquotes}
\usepackage{endnotes}

% Clean footnote and list support
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

% Make horizontal rules invisible but preserve spacing
\renewcommand{\rule}[2]{\vspace{#2}}

% Typography setup - modern sans-serif with multilingual support
\usepackage{fontspec}
\newfontfamily\japanesefont{Noto Sans JP}
\setmainfont{Noto Sans}[
    UprightFont=* Light,
    ItalicFont=* Light Italic,
    BoldFont=* Medium,
    BoldItalicFont=* Medium Italic
]
\setsansfont{Noto Sans}
\usepackage{xeCJK}
\setCJKmainfont{Noto Sans JP}[
  UprightFont=* Light]

% Colors
\definecolor{darkgray}{RGB}{64,64,64}
\definecolor{lightgray}{RGB}{128,128,128}
\definecolor{mediumgray}{RGB}{96,96,96}

% Typography settings - redefine normalsize to our desired size
\renewcommand{\normalsize}{%
  \fontsize{10}{17}\selectfont
  \SetTracking{encoding=*, shape=*}{40}
}
\normalsize  % Apply it immediately
\setlength{\parindent}{1.5em}
\setlength{\parskip}{0pt}

% Letter-spacing and hyphenation already set in normalsize
\hyphenpenalty=500  % Discourage but allow hyphenation
\tolerance=1000     % Allow slightly looser spacing to prevent overfull boxes
\emergencystretch=2em  % Allow emergency stretching for problem lines

% Chapter and section formatting - unnumbered, centered at 50%
\titleformat{\chapter}[display]
{\raggedleft\fontsize{20}{26}\selectfont\bfseries\color{darkgray}}
{}
{0em}
{}
[\vspace{1.5em}]

% Chapter spacing: position at 50% of page height
\titlespacing*{\chapter}{0pt}{0.35\textheight}{0pt}

\titleformat{\section}
{\LARGE\bfseries\color{darkgray}}
{}
{0em}
{}
[\vspace{0.5em}]

\titleformat{\subsection}
{\Large\bfseries\color{mediumgray}}
{}
{0em}
{}
[\vspace{0.3em}]

\titleformat{\subsubsection}
{\large\bfseries\color{mediumgray}}
{}
{0em}
{}

% Remove chapter/section numbering
\setcounter{secnumdepth}{-1}

% Endnotes configuration - superscript in text, normal in notes section
\renewcommand{\notesname}{Endnotes}
\renewcommand{\enotesize}{\fontsize{9.5}{15}\selectfont\SetTracking{encoding=*, shape=*}{40}}
\let\footnote=\endnote
\renewcommand{\theendnote}{\arabic{endnote}}
\renewcommand{\enoteformat}{\noindent\hangindent=2em\makebox[2em][l]{\theenmark.}}

% Header and footer
\pagestyle{fancy}
\fancyhf{}
\fancyhead[L]{\footnotesize\color{lightgray}$title$}
\fancyhead[R]{\footnotesize\color{lightgray}$author$}
\fancyfoot[C]{\footnotesize\color{lightgray}\thepage\ of \pageref{LastPage}}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}

% Hyperlink styling
\hypersetup{
    colorlinks=true,
    linkcolor=darkgray,
    urlcolor=darkgray,
    citecolor=darkgray,
    pdfborder={0 0 0},
    pdftitle={$title$},
    pdfauthor={$author$}
}

% Quote environment styling
\renewenvironment{quote}
{\begin{list}{}{\leftmargin=2em\rightmargin=2em\itshape}
\item\relax}
{\end{list}}

% Bibliography styling
\usepackage[style=chicago-authordate,backend=biber]{biblatex}
$if(bibliography)$
\addbibresource{$bibliography$}
$endif$

% CSL References environment for pandoc citeproc - hide bracket labels
\newlength{\cslhangindent}
\setlength{\cslhangindent}{1.5em}
\newlength{\csllabelwidth}
\setlength{\csllabelwidth}{0pt}
\newenvironment{CSLReferences}[2]
  {\fontsize{9.5}{15}\selectfont\SetTracking{encoding=*, shape=*}{40}
   \begin{list}{}{%
    \setlength{\itemindent}{0pt}
    \setlength{\leftmargin}{0pt}
    \setlength{\labelsep}{0pt}
    \setlength{\labelwidth}{0pt}
    \setlength{\parsep}{0pt}
    \setlength{\itemsep}{0.5\baselineskip}
    \renewcommand{\makelabel}[1]{}%  % Suppress all labels including brackets
    }}
  {\end{list}}
\newcommand{\CSLBlock}[1]{#1\hfill\break}
\newcommand{\CSLLeftMargin}[1]{}
\newcommand{\CSLRightInline}[1]{#1\break}
\newcommand{\CSLIndent}[1]{\hspace{\cslhangindent}#1}
\newcommand{\citeproctext}{}
\newcommand{\citeproc}[2]{\hypertarget{#2}{}}

\begin{document}

% Title page
\begin{titlepage}
\begin{flushright}

\vspace*{3cm}

{\fontsize{24}{30}\selectfont\bfseries\color{darkgray}$title$}

\vspace{1cm}

$if(subtitle)$
{\fontsize{16}{22}\selectfont\color{mediumgray}$subtitle$}
\vspace{1.5cm}
$endif$

$if(author)$
{\fontsize{14}{18}\selectfont\color{darkgray}$author$}
$endif$

\vfill

$if(date)$
{\color{lightgray}$date$}
$endif$

\end{flushright}
\end{titlepage}

% Table of contents
\tableofcontents
\newpage

$body$

% Endnotes section
\newpage
\addcontentsline{toc}{chapter}{Endnotes}
\theendnotes

$if(bibliography)$
\newpage
\addcontentsline{toc}{chapter}{Bibliography}
\printbibliography[title=Bibliography]
$endif$

\end{document}
